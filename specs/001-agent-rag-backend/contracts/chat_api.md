# API Contract: Chat Endpoint for Agent-Based RAG Backend using OpenAI Agent SDK

**Feature**: 001-agent-rag-backend
**Date**: 2025-12-17
**Input**: Implementation plan and data model from feature spec

## Overview

This document defines the contract for the chat API endpoint that exposes the agent-based RAG functionality using OpenAI Agent SDK with LiteLLM models. The API allows users to submit natural language queries about technical book content and receive responses generated by the agent with context retrieved from the vector database.

## API Endpoint: POST /chat

### Purpose
Accepts user queries and returns agent-generated responses that are grounded in the technical book content retrieved from the vector database via function_tool integration.

### Request

#### HTTP Method
`POST`

#### Path
`/chat`

#### Headers
```
Content-Type: application/json
Accept: application/json
```

#### Request Body Schema
```json
{
  "type": "object",
  "properties": {
    "query": {
      "type": "string",
      "description": "The natural language question from the user",
      "minLength": 1,
      "maxLength": 1000,
      "example": "What is ROS2 and how does it work?"
    },
    "user_context": {
      "type": "object",
      "description": "Optional additional context provided by the user",
      "nullable": true,
      "default": {},
      "example": {
        "technical_level": "beginner",
        "focus_area": "robotics"
      }
    }
  },
  "required": ["query"],
  "additionalProperties": false
}
```

#### Example Request
```json
{
  "query": "What is ROS2 and how does it work?",
  "user_context": {
    "technical_level": "beginner"
  }
}
```

### Response

#### Success Response (200 OK)

**Headers**
```
Content-Type: application/json
```

**Response Body Schema**
```json
{
  "type": "object",
  "properties": {
    "response": {
      "type": "string",
      "description": "The agent-generated answer to the user's query",
      "minLength": 1,
      "example": "ROS2 (Robot Operating System 2) is an open-source framework designed to make it easier and faster to develop robot applications..."
    },
    "sources": {
      "type": "array",
      "description": "Citations to book sections used in generating the response",
      "items": {
        "type": "object",
        "properties": {
          "source_file": {
            "type": "string",
            "description": "Path to the source document",
            "example": "../docs/module-01-ros2/01-introduction.md"
          },
          "section_title": {
            "type": "string",
            "description": "Title of the section containing the information",
            "example": "Introduction to ROS 2"
          },
          "chunk_id": {
            "type": "string",
            "description": "Unique identifier of the content chunk",
            "example": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
          },
          "similarity_score": {
            "type": "number",
            "description": "Relevance score between 0.0 and 1.0",
            "minimum": 0.0,
            "maximum": 1.0,
            "example": 0.85
          },
          "content_preview": {
            "type": "string",
            "description": "Short preview of the cited content",
            "example": "ROS 2 is an open-source robotics middleware suite...",
            "nullable": true
          }
        },
        "required": ["source_file", "section_title", "chunk_id", "similarity_score"],
        "additionalProperties": false
      }
    },
    "execution_time_ms": {
      "type": "number",
      "description": "Time taken to process the query in milliseconds",
      "minimum": 0,
      "example": 1577
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the response was generated",
      "example": "2025-12-17T02:05:52.449099"
    },
    "query_id": {
      "type": "string",
      "description": "Unique identifier for tracking this query",
      "example": "req-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
    }
  },
  "required": ["response", "sources", "execution_time_ms", "timestamp", "query_id"],
  "additionalProperties": false
}
```

**Example Success Response**
```json
{
  "response": "ROS2 (Robot Operating System 2) is an open-source framework designed to make it easier and faster to develop robot applications. It emphasizes modularity, real-time performance, and distributed computing capabilities for modern robotics applications.",
  "sources": [
    {
      "source_file": "../docs/module-01-ros2/01-introduction.md",
      "section_title": "Introduction to ROS 2",
      "chunk_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "similarity_score": 0.85,
      "content_preview": "ROS 2 is an open-source robotics middleware suite that provides services to develop robotic applications..."
    }
  ],
  "execution_time_ms": 1577,
  "timestamp": "2025-12-17T02:05:52.449099",
  "query_id": "req-a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

#### Error Response (400 Bad Request)

**Headers**
```
Content-Type: application/json
```

**Response Body Schema**
```json
{
  "type": "object",
  "properties": {
    "error": {
      "type": "string",
      "description": "Human-readable error message",
      "example": "Query cannot be empty"
    },
    "error_code": {
      "type": "string",
      "description": "Machine-readable error code",
      "example": "EMPTY_QUERY"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the error occurred",
      "example": "2025-12-17T02:05:52.449099"
    }
  },
  "required": ["error", "timestamp"],
  "additionalProperties": false
}
```

**Example 400 Response**
```json
{
  "error": "Query cannot be empty",
  "error_code": "EMPTY_QUERY",
  "timestamp": "2025-12-17T02:05:52.449099"
}
```

#### Server Error Response (500 Internal Server Error)

**Headers**
```
Content-Type: application/json
```

**Response Body Schema**
```json
{
  "type": "object",
  "properties": {
    "error": {
      "type": "string",
      "description": "Human-readable error message",
      "example": "Failed to process query due to internal error"
    },
    "error_code": {
      "type": "string",
      "description": "Machine-readable error code",
      "example": "INTERNAL_ERROR"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the error occurred",
      "example": "2025-12-17T02:05:52.449099"
    }
  },
  "required": ["error", "timestamp"],
  "additionalProperties": false
}
```

**Example 500 Response**
```json
{
  "error": "Failed to process query due to internal error",
  "error_code": "INTERNAL_ERROR",
  "timestamp": "2025-12-17T02:05:52.449099"
}
```

## Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| EMPTY_QUERY | 400 | The query field is empty or contains only whitespace |
| INVALID_QUERY | 400 | The query is malformed or invalid |
| QUERY_TOO_LONG | 400 | The query exceeds the maximum allowed length |
| RETRIEVAL_FAILED | 500 | Failed to retrieve context from the vector database |
| AGENT_ERROR | 500 | The AI agent failed to process the request |
| SESSION_ERROR | 500 | Failed to manage session data |
| INTERNAL_ERROR | 500 | An unexpected internal error occurred |

## Performance Requirements

- **Response Time**: 95% of requests should return within 3 seconds
- **Availability**: API should be available 99.9% of the time during operational hours
- **Throughput**: Should handle at least 10 concurrent requests without degradation

## Security Considerations

- Input validation to prevent injection attacks
- Rate limiting to prevent abuse
- Proper authentication and authorization (if implemented in future)
- Sanitization of user inputs before processing

## Versioning

This is version 1.0 of the API contract. Future versions will follow semantic versioning principles and maintain backward compatibility where possible.

## Testing Guidelines

### Success Path Tests
1. Valid query returns proper response with sources
2. Response includes execution time and timestamp
3. Sources contain proper citation information
4. Query ID is unique for each request

### Error Path Tests
1. Empty query returns 400 with appropriate error message
2. Very long query returns 400 with appropriate error message
3. Invalid JSON returns 400 with appropriate error message
4. Internal server errors return 500 with appropriate error message

### Performance Tests
1. 95% of queries return within 3 seconds
2. Concurrent requests don't cause errors
3. Large responses are handled properly

### Integration Tests
1. Agent properly calls retrieval function_tool
2. Retrieved context is used in response generation
3. Session management works across multiple requests
4. Agent uses LitellmModel for proper model integration